import csv
from pathlib import Path
import yaml

# NOTE:
# - We intentionally do NOT hardcode `configfile:` here.
# - Use `gmv run --config <...>` which passes `--configfile` and `config_dir`.
# - If you call snakemake directly, pass `--configfile` and ensure relative paths
#   in config are resolvable from `config_dir`.

if "execution" not in config:
    raise ValueError("未加载配置：请使用 gmv run 或 snakemake --configfile <config.yaml>")

EXEC = config["execution"]
RUN_ID = EXEC["run_id"]
TOOLS = config.get("tools", {}).get("enabled", {})
MOCK_MODE = bool(EXEC.get("mock_mode", False))
DEFAULT_THREADS = int(config.get("resources", {}).get("default_threads", 1))

CONFIG_DIR = Path(config.get("config_dir", ".")).expanduser().resolve()
WORK_ROOT = str(EXEC.get("work_dir", "work"))
RESULTS_ROOT = str(EXEC.get("results_dir", "results"))


def _resolve_from(base: Path, value: str) -> Path:
    p = Path(value).expanduser()
    return p if p.is_absolute() else (base / p).resolve()


# Resolve containers mapping
mapping_file = _resolve_from(CONFIG_DIR, config["containers"]["mapping_file"])
with open(mapping_file, "r", encoding="utf-8") as _mf:
    IMAGES = (yaml.safe_load(_mf) or {}).get("images", {})
IMAGES = {k: str(_resolve_from(mapping_file.parent, v)) for k, v in IMAGES.items()}

# Resolve databases (strings only)
DB = {
    k: str(_resolve_from(CONFIG_DIR, v))
    for k, v in (config.get("database", {}) or {}).items()
    if isinstance(v, str)
}

# Resolve sample sheet path
sample_sheet = _resolve_from(CONFIG_DIR, EXEC["sample_sheet"])

SAMPLE_META = {}
with open(sample_sheet, "r", encoding="utf-8") as fh:
    reader = csv.DictReader(fh, delimiter="\t")
    for row in reader:
        SAMPLE_META[row["sample"]] = row

SAMPLES = sorted(SAMPLE_META)
if not SAMPLES:
    raise ValueError("sample_sheet 中没有样本")

DOWNSTREAM_METHODS = []
if TOOLS.get("coverm", False):
    DOWNSTREAM_METHODS.append("coverm")
if TOOLS.get("bowtie2_samtools", False):
    DOWNSTREAM_METHODS.append("bowtie2_samtools")
if not DOWNSTREAM_METHODS:
    DOWNSTREAM_METHODS.append("coverm")


def meta(sample):
    return SAMPLE_META[sample]


def sample_mode(sample):
    return meta(sample).get("mode", "reads")


def raw_input1(sample):
    p = Path(meta(sample)["input1"]).expanduser()
    # Relative paths in sample sheet are resolved against the sample sheet directory.
    return str(p if p.is_absolute() else (sample_sheet.parent / p).resolve())


def raw_input2(sample):
    v = meta(sample).get("input2", "")
    if not v:
        return ""
    p = Path(v).expanduser()
    return str(p if p.is_absolute() else (sample_sheet.parent / p).resolve())


def host_name(sample):
    return meta(sample).get("host", "")


def step_dir(sample, step):
    return f"{WORK_ROOT}/{RUN_ID}/upstream/{sample}/{step}"


def result_dir(sample, step):
    return f"{RESULTS_ROOT}/{RUN_ID}/upstream/{sample}/{step}"


def detect_outputs(sample):
    outs = []
    if TOOLS.get("virsorter", False):
        outs.append(f"{WORK_ROOT}/{RUN_ID}/upstream/{sample}/5.virsorter/contigs.fa")
    if TOOLS.get("genomad", False):
        outs.append(f"{WORK_ROOT}/{RUN_ID}/upstream/{sample}/6.genomad/contigs.fa")
    return outs


def tool_cmd(tool_name):
    image = IMAGES.get(tool_name, "")
    if EXEC.get("use_singularity", True) and image:
        return f"singularity exec {image} {tool_name}"
    return tool_name


include: "rules/upstream.smk"
include: "rules/viruslib.smk"
include: "rules/downstream.smk"
include: "rules/agent.smk"


rule all:
    input:
        expand(f"{RESULTS_ROOT}/{RUN_ID}/upstream/{{sample}}/11.busco_filter/contigs.fa", sample=SAMPLES),
        f"{RESULTS_ROOT}/{RUN_ID}/viruslib/viruslib_nr.fa",
        expand(f"{RESULTS_ROOT}/{RUN_ID}/downstream/{{method}}/abundance.tsv", method=DOWNSTREAM_METHODS),
        f"{RESULTS_ROOT}/{RUN_ID}/agent/decisions.jsonl",
